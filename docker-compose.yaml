services:

  superset:
    build:
      context: .
      dockerfile: docker/superset/Dockerfile
      args:
        SUPERSET_VERSION: ${SUPERSET_VERSION:-5.0.0}
    restart: unless-stopped
    depends_on:
      database:
        condition: service_healthy
      redis:
        condition: service_healthy
    container_name: ${MAIN_CONTAINER_NAME:-superset}
    environment:
      # Database configuration
      DATABASE_DIALECT: ${DATABASE_DIALECT:-postgresql}
      DATABASE_DB: ${POSTGRES_DB:-superset}
      DATABASE_HOST: database
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD}
      DATABASE_USER: ${POSTGRES_USER:-superset}
      DATABASE_PORT: ${POSTGRES_PORT:-5432}
      SQLALCHEMY_DATABASE_URI: postgresql+psycopg2://${POSTGRES_USER:-superset}:${POSTGRES_PASSWORD}@database:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-superset}
      # Redis configuration
      REDIS_HOST: redis
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_DB: ${REDIS_DB:-0}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      # Superset configuration
      SUPERSET_SECRET_KEY: ${SUPERSET_SECRET_KEY}
      SUPERSET_APP_NAME: ${SUPERSET_APP_NAME:-Superset}
      SUPERSET_APP_ICON: ${SUPERSET_APP_ICON:-/static/assets/images/superset-logo-horiz.png}
      SUPERSET_FAVICONS: ${SUPERSET_FAVICONS:-}
      SUPERSET_BABEL_DEFAULT_LOCALE: ${SUPERSET_BABEL_DEFAULT_LOCALE:-fr}
      SUPERSET_CONFIG_PATH: /app/superset_config.py
      SUPERSET_APPLICATION_ROOT: ${SUPERSET_APPLICATION_ROOT:-/superset}
      MAPBOX_API_KEY: ${MAPBOX_API_KEY:-}
      # Matplotlib configuration
      MPLCONFIGDIR: /tmp/matplotlib-config
      # Proxy configuration for https-portal
      VIRTUAL_HOST: ${VIRTUAL_HOST:-localhost}
      VIRTUAL_PORT: 8088
      # Admin user (for initial setup)
      SUPERSET_ADMIN_USERNAME: ${SUPERSET_ADMIN_USERNAME:-admin}
      SUPERSET_ADMIN_EMAIL: ${SUPERSET_ADMIN_EMAIL:-admin@localhost}
      SUPERSET_ADMIN_PASSWORD: ${SUPERSET_ADMIN_PASSWORD}
      # Superset Chat Plugin Configuration
      SUPERSET_API_URL: ${SUPERSET_API_URL:-http://superset:8088}
      SUPERSET_USERNAME: ${SUPERSET_USERNAME:-${SUPERSET_ADMIN_USERNAME:-admin}}
      SUPERSET_PASSWORD: ${SUPERSET_PASSWORD:-${SUPERSET_ADMIN_PASSWORD}}
      TRANSPORT_TYPE: ${TRANSPORT_TYPE:-stdio}
      # LLM Provider (choose one)
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      # AWS Bedrock (optional)
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_REGION: ${AWS_REGION:-}
      # Graph Database for dbt (optional)
      GRAPH_DB: ${GRAPH_DB:-}
      GRAPH_HOST: ${GRAPH_HOST:-}
      GRAPH_USER: ${GRAPH_USER:-}
      GRAPH_PASSWORD: ${GRAPH_PASSWORD:-}
      # Langfuse Observability (optional)
      LANGFUSE_HOST: ${LANGFUSE_HOST:-}
      LANGFUSE_PUBLIC_KEY: ${LANGFUSE_PUBLIC_KEY:-}
      LANGFUSE_SECRET_KEY: ${LANGFUSE_SECRET_KEY:-}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    volumes:
      - ./docker/superset/superset_config.py:/app/superset_config.py:ro
      - ${DATA_PATH:-./appData}/superset/assets:/app/superset/static/assets/custom:ro
      - ${DATA_PATH:-./appData}/superset/translations/fr:/app/superset/translations/fr:ro
    networks:
      - superset
      - gateway

  database:
    image: postgis/postgis:${POSTGRES_VERSION:-16}-${POSTGIS_VERSION:-3.4}
    restart: unless-stopped
    container_name: ${MAIN_CONTAINER_NAME:-superset}_database
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-superset}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_USER: ${POSTGRES_USER:-superset}
      # Base de données pour les données utilisateurs (CSV uploadés, etc.)
      POSTGRES_USERDATA_DB: ${POSTGRES_USERDATA_DB:-user_data}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d ${POSTGRES_DB:-superset} -U ${POSTGRES_USER:-superset}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    volumes:
      - ${DATA_PATH:-./appData}/database/postgres:/var/lib/postgresql/data:rw
      - ./docker/postgres/init-multiple-databases.sh:/docker-entrypoint-initdb.d/init-multiple-databases.sh:ro
    networks:
      - superset

  redis:
    image: redis:${REDIS_VERSION:-7-alpine}
    restart: unless-stopped
    container_name: ${MAIN_CONTAINER_NAME:-superset}_redis
    command: >
      sh -c "if [ -n \"$$REDIS_PASSWORD\" ]; then
        redis-server --appendonly yes --requirepass \"$$REDIS_PASSWORD\";
      else
        redis-server --appendonly yes;
      fi"
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "if [ -n \"$$REDIS_PASSWORD\" ]; then redis-cli -a \"$$REDIS_PASSWORD\" ping | grep -q PONG; else redis-cli ping | grep -q PONG; fi"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - superset

  backup:
    image: prodrigestivill/postgres-backup-local
    restart: unless-stopped
    container_name: ${MAIN_CONTAINER_NAME:-superset}_backup
    environment:
      POSTGRES_HOST: database
      POSTGRES_DB: ${POSTGRES_DB:-superset},${POSTGRES_USERDATA_DB:-user_data}
      POSTGRES_USER: ${POSTGRES_USER:-superset}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      SCHEDULE: "@daily"
      BACKUP_NUM_KEEP: 7
      BACKUP_DIR: /backups
    healthcheck:
      test: ["CMD-SHELL", "test -d /backups && test -w /backups && ps aux | grep -E '[c]ron' | grep -v grep || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
      - ${DATA_PATH:-./appData}/backups:/backups
    depends_on:
      - database
    networks:
      - superset

networks:

  gateway:
    name: ${FRONTEND_NETWORK}
    external: true

  superset:
    name: ${BACKEND_NETWORK}